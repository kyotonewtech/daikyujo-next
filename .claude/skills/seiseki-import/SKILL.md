---
name: seiseki-import
description: daikyujyo.comのHTMLソースから成績データを抽出し、daikyujyo-nextプロジェクトのJSON形式に変換する。月次成績データの追加時に使用。
---

# 成績データインポートスキル

daikyujyo.comの成績ページ（seiseki.html）のHTMLソースから成績データを抽出し、daikyujyo-nextプロジェクトのJSON形式に変換するスキル。

## 使用タイミング

- ユーザーがHTMLファイル（view-source形式）を提供し、成績データの追加を依頼した時
- 「成績データを追加して」「seisekiをインポートして」等のリクエスト時

## 入力ファイル

### HTMLソースの特徴
- **エンコーディング**: Shift-JIS（文字化けして見えることがある）
- **日付行**: `<p>令和X年Y月Z日</p>` または `ߘaX�NYZ` 形式（文字化け時）
- **テーブル構造**: 6列（順位、的のサイズ、名前、級位、更新日、有効期限）

### HTMLテーブルの列構成
```
| 順位 | 的のサイズ | 名前 | 級位 | 更新日 | 有効期限 |
| 1位  | 9分       | 大﨑 | 一級 | 1/18  | 5/24    |
```

### 的のサイズの表記
- 1寸未満: 「9分」「8分」等（分単位）
- 1寸以上: 「1寸」「1寸1分」「2寸4分」等

### 級位の表記
- 段位: 「初段」「二段」「三段」「四段」「五段」等
- 級位: 「一級」「二級」「三級」「四級」「五級」等
- 称号: 「錬士」「教士」「範士」等

## 処理手順

### 1. HTMLから日付を特定
```
令和8年1月31日 → year: 2026, month: 1
```
令和年号の変換: 令和X年 = 2018 + X 年

### 2. テーブルから成績データを抽出
各行から以下を抽出:
- rank: 順位（数値）
- targetSize: 的のサイズ（文字列）
- name: 名前
- rankTitle: 級位/段位
- updatedDate: 更新日（YYYY-MM-DD形式に変換）
- expiryDate: 有効期限（YYYY-MM-DD形式に変換）

### 3. personIdの割り当て

#### 既存人物の確認
既存の成績データ（data/seiseki/YYYY/MM.json）を検索し、名前からpersonIdを特定する。

**重要**: 名前の表記揺れに注意
- 同一人物でも異体字が使われる場合がある（例: 荻野→荻埜）
- フルネームと苗字のみの違い（例: 山田功 vs 山田）

#### 新規人物の場合
既存データに名前が見つからない場合、新しいpersonIdを割り当てる:
1. 既存の最大personId番号を確認
2. person_XXX（XXXは最大番号+1）を割り当て
3. ユーザーに新規personIdの割り当てを報告

### 4. JSON形式で出力

#### 月次ファイル (data/seiseki/YYYY/MM.json)
```json
{
  "year": 2026,
  "month": 1,
  "entries": [
    {
      "id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
      "rank": 1,
      "name": "大﨑",
      "rankTitle": "一級",
      "targetSize": "9分",
      "updatedDate": "2026-01-18",
      "expiryDate": "2026-05-24",
      "personId": "person_116"
    }
  ],
  "publishedAt": "2026-01-31T00:00:00.000Z",
  "updatedAt": "2026-01-31T00:00:00.000Z"
}
```

#### index.json更新
archives配列の先頭に新しいエントリを追加:
```json
{
  "year": 2026,
  "month": 1,
  "entryCount": 10,
  "publishedAt": "2026-01-31T00:00:00.000Z"
}
```
lastUpdatedも更新する。

### 5. UUIDの生成
各エントリに一意のUUIDを生成する。形式: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

## 日付変換ルール

### 更新日・有効期限の変換
HTMLでは `1/18` や `12/20` 形式で記載されている。

#### 年の決定ロジック
- **更新日**: 成績発表年の前後で判断
  - 1月発表で更新日が12月 → 前年
  - 1月発表で更新日が1月 → 当年
- **有効期限**: 通常は更新日の約4ヶ月後
  - 更新日より月が小さい場合は翌年

#### 例（2026年1月発表）
- 更新日 `1/18` → `2026-01-18`
- 更新日 `12/20` → `2025-12-20`
- 有効期限 `5/24` → `2026-05-24`
- 有効期限 `4/5` → `2026-04-05`

## 出力ファイル

1. **新規作成**: `data/seiseki/YYYY/MM.json`
2. **更新**: `data/seiseki/index.json`

## 検証方法

データ追加後:
1. `npm run dev` でローカルサーバー起動
2. http://localhost:3000/seiseki にアクセス
3. 新しい月のデータが表示されることを確認
4. 個人成績グラフで新しいデータポイントが追加されていることを確認

## 既存personIdの参照先

既存のpersonIdを確認するには、最新の成績ファイルを参照:
- `data/seiseki/2025/11.json`
- `data/seiseki/2025/10.json`
- 等

または、特定の名前でgrepして過去の成績を検索:
```bash
grep -r "\"name\": \"津守\"" data/seiseki/
```

## 注意事項

- 新規人物のpersonId割り当ては必ずユーザーに確認・報告する
- 名前の異体字・表記揺れに注意（過去データとの一貫性を保つ）
- HTMLがShift-JISでエンコードされている場合、文字化けしていても数値と日付から推測可能
- 的のサイズの「分」と「寸」の表記を正確に維持する
